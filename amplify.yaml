version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - nvm use 18
            - echo "Extracting DATABASE_URL from secrets..."
            - export DATABASE_URL=$(node -e "console.log(JSON.parse(process.env.secrets).DATABASE_URL)")
            - echo "DATABASE_URL is: $DATABASE_URL"
            - NODE_ENV=development npm ci --legacy-peer-deps
            - npx prisma generate
            - npx prisma db pull
        build:
          commands:
            - npm run build
            - npm prune --omit=dev
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
          - node_modules/.prisma/client/libquery_engine-rhel-openssl-1.0.x.so.node
          - node_modules/.prisma/client/schema.prisma
      cache:
        paths:
          - node_modules/**/*
      environment:
        PRISMA_CLI_BINARY_TARGETS: rhel-openssl-1.0.x

backend:
  phases:
    preBuild:
      commands:
        - amplifyPush
  appRoot: .
